---
name: "Release"
on: # yamllint disable
  create:
    tags:
      - "v*"

jobs:
  publish_github:
    name: "Publish to GitHub"
    runs-on: "ubuntu-22.04"
    if: "startsWith(github.ref, 'refs/tags/v')"
    needs:
      - "tests"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"
      - name: "Set up Python"
        uses: "actions/setup-python@v3"
        with:
          python-version: "3.11"
      - name: "Install Python Packages"
        run: "pip install ansible-core"
      - name: "Build the collection"
        run: "ansible-galaxy collection build --output-path build"
      - name: "Upload binaries to release"
        uses: "svenstaro/upload-release-action@v2"
        with:
          repo_token: "${{ secrets.GH_INFRAHUB_BOT_TOKEN }}"
          file: "build/*"
          tag: "${{ github.ref }}"
          overwrite: true
          file_glob: true

  publish_galaxy:
    name: "Publish to Ansible Galaxy"
    runs-on: "ubuntu-22.04"
    if: "startsWith(github.ref, 'refs/tags/v')"
    needs:
      - "tests"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"

      - name: Build and Deploy Collection
        uses: artis3n/ansible_galaxy_collection@v2
        with:
          api_key: "${{ secrets.INFRAHUB_GALAXY_API_TOKEN }}"
  